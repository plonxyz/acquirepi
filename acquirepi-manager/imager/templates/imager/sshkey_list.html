{% extends 'imager/base.html' %}

{% block title %}SSH Keys - acquirepi Manager{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="bi bi-key"></i> SSH Keys</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{% url 'sshkey_create' %}" class="btn btn-sm btn-primary">
            <i class="bi bi-plus-circle"></i> Add SSH Key
        </a>
    </div>
</div>

{% if not ssh_keys %}
<div class="alert alert-info">
    <i class="bi bi-info-circle"></i>
    <strong>No SSH keys configured.</strong>
    SSH keys allow agents to securely upload forensic images to remote servers via SCP/SFTP.
    <a href="{% url 'sshkey_create' %}" class="alert-link">Add your first SSH key</a> to get started.
</div>
{% else %}
<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>Name</th>
                <th>Public Key Preview</th>
                <th>Jobs Using</th>
                <th>Created</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for key in ssh_keys %}
            <tr>
                <td>
                    <strong>{{ key.name }}</strong>
                </td>
                <td>
                    <code class="small">{{ key.public_key|truncatechars:60 }}</code>
                </td>
                <td>
                    {% if key.jobs.count > 0 %}
                        <span class="badge bg-info">{{ key.jobs.count }} job{{ key.jobs.count|pluralize }}</span>
                    {% else %}
                        <span class="text-muted">None</span>
                    {% endif %}
                </td>
                <td>{{ key.created_at|date:"Y-m-d H:i" }}</td>
                <td>
                    <a href="{% url 'sshkey_edit' key.id %}" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-pencil"></i> Edit
                    </a>
                    <form method="post" action="{% url 'sshkey_delete' key.id %}" style="display: inline;"
                          onsubmit="return confirm('Are you sure you want to delete SSH key \'{{ key.name }}\'?{% if key.jobs.count > 0 %} This key is currently used by {{ key.jobs.count }} job(s).{% endif %}');">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-outline-danger">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="card mt-4">
    <div class="card-header bg-light">
        <h5 class="mb-0"><i class="bi bi-info-circle"></i> About SSH Keys</h5>
    </div>
    <div class="card-body">
        <p><strong>SSH keys allow you to remotely access acquirepi agents for management and troubleshooting.</strong></p>
        <ul>
            <li>Public keys are added to agents' <code>~/.ssh/authorized_keys</code> file</li>
            <li>Keys are deployed to agents when jobs are created with them selected</li>
            <li>Use ED25519 (recommended) or RSA keys</li>
            <li>Multiple keys can be added to allow team access</li>
            <li>Public keys are safe to store - keep private keys secure on your workstation</li>
        </ul>
    </div>
</div>
{% endif %}
{% endblock %}
